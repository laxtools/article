# B2C message compiler 


 - C++ / C# 메세지 파일을 IDL에서 생성 
 - IDL은 기존 C++ 메세지와 최대한 유사하게 구성 

## 왜 필요한가? 

기존 온라인 게임 서버의 메세지 (패킷) 작성 흐름을 그대로 지원함으로써 
게임 서버 코드를 (거의) 그대로 사용 가능하게 한다. 

기존 메세지 처리 방식은 고전적인 1 바이트 alignment를 사용하여 
메모리 복사로 빠르게 메세지를 만들 수 있다. 이외에 고정길이 배열을 
사용함으로써 각종 공격을 자동으로 방어할 수 있다. 



## 해결할 문제 

모바일 장치들도 근래는 리틀 엔디안을 대부분 지원한다. 
그래도 일부 장치들은 빅 엔디안을 쓰는 경우가 있어 엔디안 변환이 필요하다. 
문자열은 게임마다 다르긴 한데 기존 서버의 경우 EUC-KR을 사용하는 것으로 보인다. 
만약 UNICODE16LE (WCHAR)를 지원한다면 포함해서 처리한다. 

- 엔디안 변환 
- 문자열 인코딩 변환 
- 메모리 복사 방식에서 필드 복사 방식 (C#만 코드 생성)

Unity가 IL2CPP를 쓰면서 기본적인 reflection 기능도 사용할 수 없다. 
1바이트 alignment가 가능한 지 살펴볼 수는 있으나 안정적이 되려면 
필드 단위 값 복사를 하는 것이 안정적이다. 



## 진행 

- IDL 정의
- IDL 파싱과 AST (문법 트리) 생성 
- C# 코드 생성과 C++ 호환 테스트 
  - 기본 타잎들 
  - 문자열 
  - 배열
  - 구조체 
- C++ 코드 생성
- 개선 작업 반복


## 테스트 

테스트 스크립트를 작성하여 진행한다. C++ 코드 생성과 빌드, C# 코드 생성과 빌드, C++과 C# 간 호환 테스트를 진행한다.  
통신 라이브러리를 작성하는 프로젝트가 아니므로 테스트는 파일을 매개로 진행한다. 

`Type | Length | Payload`

위의 형식으로 저장된 파일을 읽어서 Type 별 deserialize를 진행한다. 양방향으로 진행하여 확인한다. 
엔디안 테스트는 C#에서 두 번 변환하는 것으로 확인한다 (빅 엔디언 장치를 구하기가 어렵다). 


## 기술 기반 

- 개발 환경 
  - visual studio 2015 update 3 
  - win32 console
- 외부 라이브러리 
  - boost 
    - version 1.66.0 
    - 크기가 크고 대부분 갖고 있어 환경 변수를 사용
	- program_options, filesystem 사용 (빌드 버전 필요)
	- https://sourceforge.net/projects/boost/files/boost-binaries/1.66.0/
	  - 32 비트 버전 사용 
	  - 환경 변수 BOOST_HOME 지정 
  - boost.spirit 
    - 파싱 / AST 생성에 사용 
  - spdlog 
    - 로그 
  - nlohmann's json 
    - complete json library 




















 