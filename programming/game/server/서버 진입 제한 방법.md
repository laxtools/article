# 서버 진입 제한 방법 

무한한 사용자를 제공할 수 있는 시스템은 없다. 따라서, 서버 용량을 넘어서는 사용자 진입에 대해 제한을 걸고 적합한 시점에 다시 풀어주는 방법이 필요하다.  MMORPG는 월드 별로 서비스 단위를 분할하고 월드의 사용자 동시 접속자 수를 기준으로 대기 시스템을 구현한다. 대기열의 길이와 나의 진입 예상 시간을 알 수 있도록 하여 처리한다. 

이와 같은 시스템을 캐주얼 게임에 대해서도 제공해야 하는데 캐주얼 게임들은 분할 단위가 없다. 웹 서버 기반 게임들의 경우 서버 연결을 유지하지 않기 때문에 적절히 통제할 방법이 없다. 여기서는 이와 관련된 방법들을 찾아보려 한다. 



## 캐시 서버를 통한 정보 공유와 진입 시 제한 



### 아이디어 

아이디어는 다음과 같다. 

- 트랜잭션이 가능한 변수를 통해 현재 사용자 수를 기록 
- 진입 처리 시 해당 정보를 조회하여 일정 수치 이상이면 시도 횟수를 사용자 정보에 기록하고 거절 
  - 현재 사용자 수와 거절 횟수에 따라 진입 허용 결정



한마디로 정리하면 사용자 수가 일정 수치 이상이면 거절 횟수가 높을 경우만 허용한다. 

위와 같은 단순한 방법은 웹 기반 게임의 경우 동작하지 않는다. 왜냐하면 시스템 내에 있는 사용자 수를 판단할 정확한 방법이 없기 때문이다.  

시스템 내에 있는 사용자 수를 모른다면 다른 수치를 기준으로 할 수 있다. 예를 들어, 초당 DB 호출 건수를 관리하고 이 값을 기준으로 시스템 진입 여부를 허용하는 것이다. 



### 정의 

**시스템 부하 지표**는  시스템이 바쁜 정도를 나타내는 값으로 TPS 또는 TPM으로 한다.  TPS는 초당 요청 건수, TPM은 분당 요청 건수이다.  TPS 또는 TPM은 요청 건수의 초당 또는 분당 평균 값을 이동 평균으로 계산한다.  

**진입 거절 횟수**는 시스템 부하 지표에 따른 각 사용자당 거절 횟수이다. 진입하면 0으로 초기화 된다. 



### 알고리즘 

- 게임에 대한 요청이 오면 시스템 부하 지표를 갱신한다
  - 이동 평균 값으로 계산한다 
- 게임에 대한 로그인 요청이 오면 시스템 부하 지표와 진입 거절 횟수를 가져온다 
  - 부하 지표와 해당 사용자의 거절 횟수에 따라 진입 허용 여부를 결정한다. 
  - 거절할 때는 현재 바쁜 정도와 대기 시간을 표시한다. 



## 시스템 증설 

알려주는 대신 시스템의 용량을 늘릴 수 있으면 더 좋다.  웹 기반 SNG 게임의 경우 증설이 가장 어려운 부분은 DB이다. RDBMS의 경우 아직 자동으로 확장 가능한 샤딩을 제공하지 않는다.  

몇 가지 키 기반의 테이블별 샤딩 미들웨어가 있지만 완전하지 않다. 애플리케이션에서 샤딩하는 방법은 여전히 유효하다.  Proxy 기반으로 처리 시스템을 만들면 상세 내용을 숨길 수 있으나 개발 비용은 증가한다. 완전한 프록시는 불가능해 보이고 현실적인 서비스 제공이 최선이다. 

샤딩된 DB의 증설은 rehashing이 핵심이다.  키 기반이라 키에 해당하는 DB를 증설된 내용에 따라 변경해야 한다. 모듈라 연산 (키를 나눈 나머지로 DB 할당)  방식은 필수적으로 DB 증설에 따라 데이터 조정 작업이 필요하다. 사용자 테이블에 현재 DB를 두는 방식은 변경이 필요 없다.  

샤딩은 랜덤 분포에 기초하고 있다. 랜덤 분포의 대상은 사용 요청이다.  요청이 특정 DB의 사용자들에 몰린다면 성능이 잘 올라가지 않는다. 

샤딩 자체는 중요한 별도 주제이다. 캐주얼 게임이나 대규모 사용자를 받는 웹 시스템에서 중요하다. 



### 참고 자료 

https://d2.naver.com/helloworld/14822

RDBMS의 샤딩에 관한 네이버의 자료. 

















 



