# 테스트 프레임워크 

단위 테스트 프레임워크는 많이 있다. 게임 서버의 경우 연결을 맺고 메세지 중심으로 서버와 테스트를 진행할 툴이 필요하다. 이를 보통 부하 테스트 툴 또는 봇툴이라 부른다. 



## 주요 기능  



### 시나리오 구성 

시나리오를 구성할 수 있어야 한다. yaml로 한번, json으로 한번 구성해 보았다. yaml은 프로그래머가 아닌 사람들이 사용하기 번거로웠다. json은 따옴표나 말들이 많아진다 (high verbosity). cson과 같이 보다 간결한 포맷을 사용할 수도 있지만 json으로도 충분하다. 



### 테스트 단위와 흐름의 구성 

하나의 요청과 응답에 대해 테스트를 구성하고 이를 시나리오로 묶으려면 FSM의 하나의 상태 처럼 만드는 것이 좋다. 해당 상태는 시작되고 실행되고 결과를 판정하여 외부에 알려준다. 결과에 따라 다음 테스트를 선택하는 구성을 시나리오로 만든다. 이 단위를 Act라고 하고 결과를 Slot으로 한다. Slot에 따라 다음 Act를 연결한다. 

이런 일련의 Act들을 Flow라고 한다. Flow는 하나의 연결을 갖는 Agent(또는 Bot)에서 실행된다. 

간단한 개념이지만 강력하다. 항상 실행되고 있어야 하는 Act도 필요해질 때가 있는데 그럴 경우 별도로 게임별로 구성하는 것이 낫다. 활성화 되고 꺼지고 하는 동적인 변화가 발생하면 관리가 어려워질 수 있다. 이를 수용할 수 있는 개념의 확장이 필요하다. 



### 여러 Agent의 실행 

부하 테스트 도구들이 이런 기능을 수행할 수 있다. 대부분 테스트 배포 기능을 함께 갖고 있다. Grinder가 .NET을 지원하는 모듈이 있고 테스트 배포 기능도 갖고 있다. 직접 제작할 것이 아니라면 .NET으로 개발하는 것도 괜찮은 선택이다. C# 프로토콜만 지원하면 사용할 수 있다. 



## 구현 사례 



### 사례 1

Grinder와 Script.NET을 사용하고 .NET 프로젝트로 Flow, Act를 핵심으로 하며 시나리오를 json으로 구성하도록 구현했다. 

큐를 중심에 두고 Act들은 json 메세지만 사용하고 통신할 때 각 게임에 맞게 변환하도록 했다. 이렇게 하면 프로그래밍 경험이 적은 사람들도 어느 정도 테스트를 작성할 수 있다. 



### 사례 2

위와 유사한 Flow, Act 기반 하에 C++로 구현했다. 자체적으로 부하 실행 기능을 갖도록 했다. 시나리오는 yaml을 사용하도록 했다. yaml의 tab 기능, 위치 맞추기 때문에 귀찮은 적이 많았다. 따라서, 좋은 포맷은 아니다. 

다른 기능은 대부분 만족스러웠다. 게임 실행에 진입할 경우 서버의 정보를 받아서 저장하고 관리할 필요가 있는데 이도 Act로 구현했다. 

json 변환 기능 등이 없어 메세지는 게임 메시지를 그대로 사용했다.  C++ 11로 lambda 기반의 subscribe/publish 구조를 사용했는데 매우 만족 스럽다.  게임 코드 수정을 따라가는 게 조금 번거롭기는 했다.

예외 사항을 많이 발생시켜 서버 안정성을 항상 시키는데 많은 도움이 되었다. 예외 사항은 다양한 상태를 반복하는 에이전트들을 한번에 종료 시키는 방식으로 진행했다. 



